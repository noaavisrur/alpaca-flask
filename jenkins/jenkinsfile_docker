pipeline {
    agent any

    environment {
        // Initialize the initial version tag
        versionTag = '1.0'
        previousTag = ''
        repositoryName = 'alpaca-flask'
        dockerHubUsername = 'noaavisrur'
        newTag = ''
        currentTag = ''
        test_server = ' ' 
        prod_server = ' '
    }

    stages {
        stage('Clean up & clone') {
            steps {
                sh 'sudo rm -rf *'
                sh 'git clone https://github.com/noaavisrur/alpaca-flask.git'
            }
        }
        
        stage('Build and Push Docker Image') {
            steps {
                dir('alpaca-flask/flask/flask-app') {
                    sh "docker build -t ${dockerHubUsername}/${repositoryName}:latest ."
                    sh "docker push ${dockerHubUsername}/${repositoryName}:latest"
                }
            }
        }
     stage('Deploy Docker into EC2 Test-Servers') {
    steps {
        // Configure AWS credentials
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'noaavisrur']]) {
            // Install AWS CLI (if not already installed)
            sh 'pip install awscli --upgrade --user'
            // Start EC2 instance
            sh 'aws ec2 start-instances --instance-ids i-0cfdbf11a0eef79f0 --region us-east-1'
            // Pull & run the Docker image
              sh 'docker stop my-container'
              sh 'docker rm my-container'
           sh 'docker run -d -p 81:80 --rm --name my-container noaavisrur/alpaca-flask:latest'

        }
    }
}

    }
}
